<html>
<body>
<div id="guest">
	<input type="email" id="email" placeholder="enter email" />
	<button id="go">Go</button>
	<div id="wait" style="display: none">Open the link in the email</div>
</div>
<div id="user" style="display: none">
	<div>Welcome, user!</div>
	<div id="info"></div>
</div>
<script>
	function parseJwt(token) {
	    var base64Url = token.split('.')[1];
	    var base64 = base64Url.replace('-', '+').replace('_', '/');
	    return JSON.parse(window.atob(base64));
	};

	async function validate() {
		const token = localStorage.getItem('token');
		const response = await fetch(`/token/status/${encodeURIComponent(token)}`);
		if(response.status === 200) {
			renderInfo();
			document.getElementById('guest').style.display = 'none';
			document.getElementById('user').style.display = 'block';
		}
	}

	function renderInfo() {
		const token = localStorage.getItem('token');
		const info = parseJwt(token);
		document.getElementById('info').innerHTML = JSON.stringify(info);
	}

	validate();
	document.getElementById('go').onclick = function() {
		const emailElement = document.getElementById('email');
		const email = emailElement.value;
		const data = {user: email, params: {r: Math.random()}};
		fetch('/key', {
			body: JSON.stringify(data),
			mode: 'cors',
			method: 'post',
		    headers: {
		      'content-type': 'application/json'
		    },
		}).then(function(res) {
			return res.json();
		}).then(function({zp}) {
			const interval = setInterval(async function() {
				const res = await fetch('/token/'+zp);
				if(res.status === 200) {
					clearInterval(interval);
					const {token} = await res.json();
					localStorage.setItem('token', token);
				} else {
					console.log('forbidden');
				}
			}, 1000);
		});
		emailElement.style.display = 'none';
		document.getElementById('wait').style.display = 'block';
	};
</script>
</body>
</html>